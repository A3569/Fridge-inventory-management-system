{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Shopping List</h2>
    {% csrf_token %}
    <table class="table mt-4">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in shopping_items %}
            <tr>
                <td>{{ item.item_type.name }}</td>
                <td>{{ item.amount }}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="purchaseItem('{{ item.item_type.unique_barcode }}', '{{ item.item_type.name }}', {{ item.amount }})">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeFromList('{{ item.item_type.unique_barcode }}', {{ item.amount }})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <form id="add-form" class="mt-4" onsubmit="addToShoppingList(event)">
        {% csrf_token %}
        <div class="form-group">
            <label for="item_type">Add Item:</label>
            <select name="item_type" id="item_type" class="form-control" required>
                <option value="">Select an item...</option>
                {% for item_type in item_types %}
                    <option value="{{ item_type.unique_barcode }}">{{ item_type.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="amount">Amount:</label>
            <input type="number" name="amount" id="amount" class="form-control" value="1" min="1" required>
        </div>

        <button type="submit" class="btn btn-primary">Add to Shopping List</button>
    </form>
</div>

<!-- Purchase Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Purchase Item</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Purchasing: <span id="purchaseItemName"></span></p>
                <p>Available amount: <span id="availableAmount"></span></p>
                <div class="form-group">
                    <label for="purchaseAmount">Amount to purchase:</label>
                    <input type="number" id="purchaseAmount" class="form-control" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="purchaseExpiration">Expiration Date:</label>
                    <input type="date" id="purchaseExpiration" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPurchase()">Purchase</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPurchaseItemType = null;
let currentMaxAmount = 0;

function addToShoppingList(event) {
    event.preventDefault();
    
    const itemType = document.getElementById('item_type').value;
    const amount = document.getElementById('amount').value;

    fetch('/api/v1/addToShoppingList', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'include',
        body: JSON.stringify({
            itemType: itemType,
            amount: parseInt(amount)
        })
    })
    .then(response => {
        if (response.status === 200) {
            location.reload();
        } else {
            alert('Failed to add item to shopping list');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add item to shopping list');
    });
}

function removeFromList(itemType, amount) {
    fetch('/api/v1/removeFromShoppingList', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'include',
        body: JSON.stringify({
            itemType: itemType,
            amount: amount
        })
    })
    .then(response => {
        if (response.status === 200) {
            location.reload();
        } else {
            alert('Failed to remove item from shopping list');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove item from shopping list');
    });
}

function purchaseItem(itemType, itemName, maxAmount) {
    currentPurchaseItemType = itemType;
    currentMaxAmount = maxAmount;
    document.getElementById('purchaseItemName').textContent = itemName;
    document.getElementById('availableAmount').textContent = maxAmount;
    document.getElementById('purchaseAmount').max = maxAmount;
    document.getElementById('purchaseAmount').value = Math.min(1, maxAmount);
    
    // Set default expiration date to 7 days from now
    const defaultDate = new Date();
    defaultDate.setDate(defaultDate.getDate() + 7);
    document.getElementById('purchaseExpiration').value = defaultDate.toISOString().split('T')[0];
    
    $('#purchaseModal').modal('show');
}

function confirmPurchase() {
    const amount = parseInt(document.getElementById('purchaseAmount').value);
    const expirationDate = document.getElementById('purchaseExpiration').value;

    if (amount > currentMaxAmount) {
        alert(`Cannot purchase more than ${currentMaxAmount} items`);
        return;
    }

    fetch('/api/v1/purchaseItem', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'include',
        body: JSON.stringify({
            itemType: currentPurchaseItemType,
            amount: amount,
            expirationDate: expirationDate
        })
    })
    .then(response => {
        if (response.status === 200) {
            $('#purchaseModal').modal('hide');
            location.reload();
        } else {
            alert('Failed to purchase item. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to purchase item. Please try again.');
    });
}
</script>
{% endblock %}